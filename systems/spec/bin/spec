#!/usr/bin/env bash
set -euo pipefail

# Determine the directory where this script lives
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LIB_DIR="${SCRIPT_DIR}/../lib"

# Version
VERSION="0.1.0"

# Source config and utility files if they exist
[[ -f "${LIB_DIR}/config.sh" ]] && source "${LIB_DIR}/config.sh"
[[ -f "${LIB_DIR}/utils.sh" ]] && source "${LIB_DIR}/utils.sh"

# Usage information
usage() {
    cat <<'EOF'
spec - Specification management for AI coding agents

Usage: spec <command> [options]

Commands:
  init      Initialize specs directory
  list      List all specifications

All other operations handled by /spec agent command.
EOF
}

# Show version
version() {
    echo "spec version ${VERSION}"
}

# Main command routing
main() {
    # Handle no arguments
    if [[ $# -eq 0 ]]; then
        usage
        exit 1
    fi

    local command="$1"
    shift

    # Handle global flags
    case "${command}" in
        --help|-h)
            usage
            exit 0
            ;;
        --version)
            version
            exit 0
            ;;
    esac

    # Route to command scripts
    local command_script="${LIB_DIR}/commands/${command}.sh"

    case "${command}" in
        init|list)
            if [[ -f "${command_script}" ]]; then
                source "${command_script}"
                "cmd_${command}" "$@"
            else
                echo "Error: Command script not found: ${command_script}" >&2
                exit 1
            fi
            ;;
        *)
            echo "Use /spec agent command" >&2
            exit 1
            ;;
    esac
}

main "$@"
